{% extends 'base.html' %} {% load static %} {% load l10n %} {% block content %}

<section class="section-content padding-y bg">
  <div class="container">
    <h4 class="text-center mb-20">Review Your Order and Make Payment</h4>
    <div class="row">
      <!-- LEFT SIDE -->
      <aside class="col-lg-8">
        <!-- BILLING -->
        <div class="card mb-3">
          <h5 class="card-header">Billing Address</h5>
          <div class="card-body">
            <p class="mb-0">{{order.full_name}}</p>
            <p class="mb-0">{{order.full_address}}</p>
            <p class="mb-0">{{order.city}}, {{order.state}}</p>
            <p class="mb-0">{{order.country}}</p>
            <p class="mb-0">{{order.email}}</p>
            <p class="mb-0">{{order.phone}}</p>

            {% if order.order_note %}
            <b>Order Note: </b> {{order.order_note}} {% endif %}
          </div>
        </div>

        <!-- PAYMENT METHOD -->
        <div class="card mb-3">
          <h5 class="card-header">Payment Method</h5>
          <div class="card-body">
            <p class="card-text">PayPal / Cash on Delivery</p>
          </div>
        </div>

        <!-- PRODUCT REVIEW -->
        <div class="card">
          <h5 class="card-header">Review Products</h5>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th width="120" class="text-center">Quantity</th>
                    <th width="120" class="text-end">Price</th>
                  </tr>
                </thead>
                <tbody>
                  {% for cart_item in cart_items %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center gap-3">
                        {% if cart_item.product.product_image %}
                        <img src="{{ cart_item.product.product_image.url }}" width="70" height="70" 
                             style="object-fit: cover; border-radius: 4px;" />
                        {% else %}
                        <div style="width: 70px; height: 70px; background: #e0e0e0; border-radius: 4px;"></div>
                        {% endif %}
                        <div>
                          <a href="{{ cart_item.product.get_url }}" class="text-decoration-none fw-semibold text-dark">
                            {{ cart_item.product.product_name }}
                          </a>
                          <div class="text-success fw-bold">₹{{ cart_item.product.price }}</div>
                          {% if cart_item.variations.all %}
                            <small class="text-muted">
                              {% for variation in cart_item.variations.all %}
                                {{ variation.variation_category|title }}: <strong>{{ variation.variation_value|title }}</strong>
                                {% if not forloop.last %}, {% endif %}
                              {% endfor %}
                            </small>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td class="text-center align-middle">
                      <span class="fw-bold">{{ cart_item.quantity }}</span>
                    </td>
                    <td class="fw-bold text-end align-middle">₹{{ cart_item.sub_total }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT SIDE -->
      <aside class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <dl class="dlist-align">
              <dt>Total price:</dt>
              <dd class="text-right">₹ {{total}}</dd>
            </dl>

            <dl class="dlist-align">
              <dt>Tax:</dt>
              <dd class="text-right">₹ {{tax}}</dd>
            </dl>

            <dl class="dlist-align">
              <dt>Grand Total:</dt>
              <dd class="text-right text-dark b">
                <strong>₹ {{grand_total}}</strong>
              </dd>
            </dl>

            <hr />

            <p class="text-center mb-3">
              <img src="{% static 'images/misc/payments.png' %}" height="26" />
            </p>

            <!-- PAYPAL -->
            <div id="paypal-button-container" class="mb-3" style="min-height: 40px; border: 1px dashed red;"></div>

            <!-- RAZORPAY BUTTON -->
            <button id="razorpay-button" class="btn btn-primary btn-block mb-3" type="button">
              Pay with Razorpay
            </button>

            <!-- COD BUTTON -->
            <form action="{% url 'cod_payments' %}" method="POST">
              {% csrf_token %}
              <input
                type="hidden"
                name="orderID"
                value="{{order.order_number}}"
              />
              <button class="btn btn-dark btn-block" type="submit">
                Cash on Delivery (COD)
              </button>
            </form>
          </div>
        </div>
      </aside>
    </div>
  </div>
</section>

<script>
  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  var amount = "{{ grand_total|unlocalize }}";
  var url = "{% url 'payments' %}";
  var csrftoken = getCookie("csrftoken");
  var orderID = "{{order.order_number}}";
  var payment_method = "PayPal";
  var redirect_url = "{% url 'order_complete' %}";
  
  // Debugging
  console.log("Initializing PayPal Button...");
  console.log("Amount:", amount);
  console.log("Order ID:", orderID);

  if (typeof paypal === 'undefined') {
      console.error("PayPal SDK not loaded! The 'paypal' object is undefined.");
      console.error("This usually means the script in base.html failed to load or was blocked.");
      alert("PayPal SDK failed to load. Please check your internet connection or ad blocker.");
  } else {
      paypal
        .Buttons({
          style: {
            color: "blue",
            shape: "rect",
            label: "pay",
            height: 40,
          },

          createOrder: function (data, actions) {
            return actions.order.create({
              purchase_units: [
                {
                  currency_code: "USD",
                  amount: { value: amount },
                },
              ],
            });
          },

          onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
              // Show a success message to the buyer
              console.log("Payment successful", details);
              sendData();

              function sendData() {
                fetch(url, {
                  method: "POST",
                  headers: {
                    "Content-type": "application/json",
                    "X-CSRFToken": csrftoken,
                  },
                  body: JSON.stringify({
                    orderID: orderID,
                    transID: details.id,
                    payment_method: payment_method,
                    status: details.status,
                  }),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    window.location.href =
                      redirect_url +
                      "?order_number=" +
                      data.order_number +
                      "&payment_id=" +
                      data.transID;
                  });
              }
            });
          },
          onError: function (err) {
              console.error('PayPal Button Error:', err);
              alert("An error occurred with PayPal: " + err);
          }
        })
        .render("#paypal-button-container");
  }

  // RAZORPAY INTEGRATION
  if (typeof Razorpay === 'undefined') {
      console.error("Razorpay SDK not loaded! The 'Razorpay' object is undefined.");
      console.error("This usually means the script in base.html failed to load or was blocked.");
      document.getElementById('razorpay-button').disabled = true;
      document.getElementById('razorpay-button').textContent = 'Razorpay Unavailable';
  } else {
      console.log('Razorpay SDK loaded successfully.');
      
      document.getElementById('razorpay-button').addEventListener('click', function() {
          // Create order on server first
          fetch("{% url 'razorpay_create_order' %}", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrftoken,
              },
              body: JSON.stringify({
                  orderID: orderID,
                  amount: amount
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.error) {
                  alert("Error creating order: " + data.error);
                  return;
              }

              // Open Razorpay checkout
              var options = {
                  key: "{{ RAZORPAY_KEY_ID }}",
                  amount: data.amount,
                  currency: "INR",
                  name: "E-Commerce Store",
                  description: "Order #" + orderID,
                  order_id: data.razorpay_order_id,
                  handler: function (response) {
                      // Payment successful, send to server for verification
                      fetch("{% url 'razorpay_callback' %}", {
                          method: "POST",
                          headers: {
                              "Content-Type": "application/json",
                              "X-CSRFToken": csrftoken,
                          },
                          body: JSON.stringify({
                              orderID: orderID,
                              razorpay_payment_id: response.razorpay_payment_id,
                              razorpay_order_id: response.razorpay_order_id,
                              razorpay_signature: response.razorpay_signature
                          })
                      })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              window.location.href = redirect_url + 
                                  "?order_number=" + data.order_number + 
                                  "&payment_id=" + data.payment_id;
                          } else {
                              alert("Payment verification failed: " + data.error);
                          }
                      })
                      .catch(error => {
                          console.error('Error:', error);
                          alert("An error occurred while processing your payment.");
                      });
                  },
                  prefill: {
                      name: "{{ order.full_name }}",
                      email: "{{ order.email }}",
                      contact: "{{ order.phone }}"
                  },
                  theme: {
                      color: "#3399cc"
                  },
                  modal: {
                      ondismiss: function() {
                          console.log('Razorpay checkout cancelled by user.');
                      }
                  }
              };

              var rzp = new Razorpay(options);
              rzp.open();
          })
          .catch(error => {
              console.error('Error:', error);
              alert("An error occurred while creating the order.");
          });
      });
  }
</script>

{% endblock %}
